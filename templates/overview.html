{% extends "base.html" %}
{% block content %}

<h1>Pacific PFM Regional Coordination Dashboard</h1>
<p class="muted">A quick visual summary of regional performance.</p>

<div class="grid-2">
  <div class="card">
    <h2 class="card-title">Overall Score Distribution</h2>
    <div class="chart-wrap">
      <canvas id="bandChart"></canvas>
    </div>
  </div>

  <div class="card">
    <h2 class="card-title">Average Dimension Scores</h2>
    <div class="chart-wrap">
      <canvas id="dimensionChart"></canvas>
    </div>
  </div>
</div>

<div class="card">
  <h2 class="card-title">Country Overall Scores</h2>
  <p class="muted">Click a bar to open the country detail page.</p>
  <div class="chart-wrap chart-tall">
    <canvas id="countryChart"></canvas>
  </div>
</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>Metric</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
      {% for row in summary %}
      <tr>
        <td>{{ row.metric }}</td>
        <td>{{ row.value }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<a href="/countries" class="btn-primary">View Countries</a>

<script>
  const BAND_COLORS = {
    "Very Strong": "#1aa179",
    "Strong": "#4caf50",
    "Moderate": "#ffc107",
    "Weak": "#dc3545",
    "N/A": "#b9c2cc"
  };

  // Donut
  new Chart(document.getElementById("bandChart"), {
    type: "doughnut",
    data: {
      labels: Object.keys({{ band_counts | tojson }}),
      datasets: [{
        data: Object.values({{ band_counts | tojson }}),
        backgroundColor: Object.keys({{ band_counts | tojson }}).map(k => BAND_COLORS[k])
      }]
    },
    options: { cutout: "60%" }
  });

  // Dimension bars
  new Chart(document.getElementById("dimensionChart"), {
    type: "bar",
    data: {
      labels: Object.keys({{ dimension_avgs | tojson }}),
      datasets: [{
        data: Object.values({{ dimension_avgs | tojson }}),
        backgroundColor: "#0ea5e9",
        borderRadius: 10
      }]
    },
    options: { plugins: { legend: { display: false } } }
  });

  // Country bars
  const countryData = {{ country_scores | tojson }};
  const countryChart = new Chart(document.getElementById("countryChart"), {
    type: "bar",
    data: {
      labels: countryData.map(c => c.name),
      datasets: [{
        data: countryData.map(c => c.score),
        backgroundColor: countryData.map(c => BAND_COLORS[c.band]),
        borderRadius: 10
      }]
    },
    options: {
      indexAxis: "y",
      plugins: { legend: { display: false } }
    }
  });

  document.getElementById("countryChart").onclick = e => {
    const p = countryChart.getElementsAtEventForMode(e, "nearest", { intersect: true }, true);
    if (p.length) window.location.href = countryData[p[0].index].url;
  };
</script>

{% endblock %}
